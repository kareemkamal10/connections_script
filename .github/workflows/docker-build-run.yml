name: Build and Test Docker

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  vpn-script-ci-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx with cache
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Docker image optimized for CI
        run: |
          echo "Building Docker image optimized for CI..."
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new \
            --load \
            -t secure-connection-ci .

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Test Docker image build
        run: |
          docker images secure-connection-ci

      - name: Run CI status check
        run: |
          echo "Running enhanced status check in CI mode..."
          docker run --rm \
            -e CI=true \
            -e GITHUB_ACTIONS=true \
            --network=host \
            secure-connection-ci python3 main.py --status-only --verbose

      - name: Test basic container functionality
        run: |
          echo "Testing container basic functionality..."
          docker run --rm secure-connection-ci python3 --version

      - name: Test network connectivity in container
        run: |
          echo "Testing network connectivity..."
          docker run --rm --network=host secure-connection-ci ping -c 3 8.8.8.8 || true

      - name: Test DNS resolution in container
        run: |
          echo "Testing DNS resolution..."
          docker run --rm --network=host secure-connection-ci nslookup google.com || true

      - name: Validate CI simulation
        run: |
          echo "Validating CI simulation results..."
          docker run --rm \
            -e CI=true \
            -e GITHUB_ACTIONS=true \
            --network=host \
            secure-connection-ci python3 -c "
          import sys
          import os
          sys.path.append('/app')
          print('üîç CI Validation Tests:')
          print(f'   CI Environment: {os.getenv(\"CI\") == \"true\"}')
          print(f'   GitHub Actions: {os.getenv(\"GITHUB_ACTIONS\") == \"true\"}')
          try:
              from main import is_ci_environment
              print(f'   CI Detection Function: {is_ci_environment()}')
          except Exception as e:
              print(f'   Import Error: {e}')
          print('‚úÖ All CI validations passed!')
          "

      - name: Test Docker image build (release)
        run: |
          docker images secure-connection

      - name: Test basic container functionality (release)
        run: |
          echo "Testing container basic functionality..."
          docker run --rm secure-connection python3 --version

      - name: Test network connectivity in container (release)
        run: |
          echo "Testing network connectivity..."
          docker run --rm --network=host secure-connection ping -c 3 8.8.8.8 || true

      - name: Test DNS resolution in container (release)
        run: |
          echo "Testing DNS resolution..."
          docker run --rm --network=host secure-connection nslookup google.com || true

      - name: Run status check only (safe mode)
        run: |
          echo "Running status check in safe mode..."
          docker run --rm --network=host \
            -e TEST_MODE=true \
            secure-connection python3 main.py --status-only || true

      - name: Test environment check script
        run: |
          echo "Testing environment check..."
          docker run --rm secure-connection python3 check_environment.py || true

      # This step will only run if we're not in GitHub Actions (commented out for safety)
      # - name: Run full setup (requires privileged mode)
      #   run: |
      #     echo "‚ö†Ô∏è  Full setup requires privileged access - skipping in CI"
      #     echo "To run full setup locally, use:"
      #     echo "docker run --privileged --cap-add=NET_ADMIN --cap-add=SYS_ADMIN -it secure-connection"
